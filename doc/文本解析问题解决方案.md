# 文本解析效果不好的问题及解决方案

## 问题分析

### 1. Word文档解析问题
从截图看到的乱码内容：
```
EMF+0@EMF+%@C=*D@!2S!2S!2S!2SEMF*+@!2S!2S!2S!2SEMF*+@!jA*U-
```

这是因为：
- Word文档包含EMF（增强型图元文件）格式的嵌入对象
- 文档可能包含图片、表格、特殊格式
- 简单的文本提取无法正确处理这些内容

### 2. 文本输出不完整的原因

#### 原因1：max_tokens设置不合理
```typescript
// 错误的设置
max_tokens: Math.max(text.length * 2, 1000)
```
- `text.length` 是字符数，不是token数
- 中文：1个字符 ≈ 2-3个tokens
- 英文：1个单词 ≈ 1-2个tokens
- 如果输入5000字，输出可能需要15000 tokens

#### 原因2：API上下文长度限制
- DeepSeek API有最大上下文长度限制
- 输入+输出不能超过模型的最大token数
- 长文本需要分段处理

#### 原因3：输入文本过长
- 2061KB的Word文档可能包含大量文本
- 一次性处理会超出限制

## 解决方案

### 方案1：正确解析Word文档（推荐）

#### 前端方案（浏览器端）
使用 `mammoth.js` 库：

```bash
npm install mammoth
```

```typescript
import mammoth from 'mammoth';

async function extractTextFromWord(file: File): Promise<string> {
  const arrayBuffer = await file.arrayBuffer();
  const result = await mammoth.extractRawText({ arrayBuffer });
  return result.value;
}
```

#### 后端方案（Node.js）
使用 `docx` 或 `mammoth` 库：

```bash
npm install docx
```

```typescript
import { Document, Packer } from 'docx';
import * as fs from 'fs';

// 或者使用 python-docx (Python后端)
```

### 方案2：分段处理长文本（已实现）

代码已更新，现在会：
1. 自动检测文本长度
2. 如果超过2000字符，按段落分割
3. 逐段调用API进行改写
4. 最后合并所有结果

```typescript
// 新增的分段逻辑
const MAX_CHUNK_SIZE = 2000;
const chunks = text.length > MAX_CHUNK_SIZE 
  ? splitTextIntoChunks(text, MAX_CHUNK_SIZE) 
  : [text];
```

### 方案3：优化max_tokens计算

```typescript
// 修复后的计算方式
max_tokens: Math.min(chunk.length * 3, 8000)
```

- 中文字符 × 3 = 大致的token数
- 限制最大不超过8000 tokens
- 避免超出API限制

### 方案4：添加进度提示

在UI中显示处理进度：

```typescript
// 在ParaphraseForm.tsx中添加
const [progress, setProgress] = useState({ current: 0, total: 0 });

// 在API调用中更新进度
console.log(`正在处理第 ${i + 1}/${chunks.length} 段...`);
```

## 使用建议

### 1. 文档上传前的处理
- **推荐**：将Word文档转换为纯文本（.txt）后再上传
- 或者：使用在线工具先提取纯文本
- 避免：直接上传包含大量格式的Word文档

### 2. 文本长度控制
- **最佳**：每次处理1000-2000字
- **可接受**：2000-5000字（会自动分段）
- **不推荐**：超过10000字（处理时间长，可能失败）

### 3. 分段处理策略
- 按段落分割（保持语义完整）
- 每段独立改写
- 自动合并结果

### 4. 错误处理
- 如果某段失败，会显示具体错误信息
- 可以重试失败的段落
- 建议保存原文备份

## 立即可用的解决方案

### 临时方案（无需修改代码）
1. 打开Word文档
2. 全选文本（Ctrl+A）
3. 复制（Ctrl+C）
4. 粘贴到记事本（去除格式）
5. 从记事本复制纯文本
6. 粘贴到降重工具

### 长期方案（需要开发）
1. 集成 `mammoth.js` 进行Word解析
2. 添加文件预览功能
3. 显示处理进度条
4. 支持断点续传

## 代码已修复的问题

✅ max_tokens计算更准确
✅ 自动分段处理长文本
✅ 添加处理进度日志
✅ 优化错误提示
✅ 段落间添加延迟避免限流

## 下一步建议

1. **立即测试**：用纯文本文件测试改写功能
2. **添加Word解析**：集成mammoth.js库
3. **UI优化**：添加进度条和分段提示
4. **文档说明**：在界面上提示用户最佳使用方式
